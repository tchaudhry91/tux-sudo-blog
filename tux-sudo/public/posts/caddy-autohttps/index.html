<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"  lang="en-us">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<title>Caddy! Team 443 FTW | Tux-Sudo</title>



<link rel="stylesheet" href="/css/style.css"/><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
<link rel="canonical" href="https://blog.tux-sudo.com/posts/caddy-autohttps/">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">
</head>
<body>
<section class="section">
  <div class="container">
    <nav id="nav-main" class="nav">
      <div id="nav-name" class="nav-left">
        <a id="nav-anchor" class="nav-item" href="https://blog.tux-sudo.com">
          <h1 id="nav-heading" class="title is-4">Tux-Sudo</h1>
        </a>
      </div>
      <div class="nav-right">
        <nav id="nav-items" class="nav-item level is-mobile"><a class="level-item" aria-label="github" href='https://github.com/tchaudhry91'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="twitter" href='https://twitter.com/Tuxybuzz13'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="linkedin" href='https://linkedin.com/in/tanmay-chaudhry-72b0b827'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path stroke-width="1.8" d="m5.839218,4.101561c0,1.211972 -0.974141,2.194011 -2.176459,2.194011s-2.176459,-0.982039 -2.176459,-2.194011c0,-1.211094 0.974141,-2.194011 2.176459,-2.194011s2.176459,0.982917 2.176459,2.194011zm0.017552,3.94922l-4.388022,0l0,14.04167l4.388022,0l0,-14.04167zm7.005038,0l-4.359939,0l0,14.04167l4.360816,0l0,-7.370999c0,-4.098413 5.291077,-4.433657 5.291077,0l0,7.370999l4.377491,0l0,-8.89101c0,-6.915523 -7.829986,-6.66365 -9.669445,-3.259423l0,-1.891237z"/>
    
  </svg></i>
            </span>
          </a></nav>
      </div>
    </nav>

    <nav class="nav">
      
      <div class="nav-left"><a class="nav-item" href="https://blog.tux-sudo.com">
          <h2 class="title is-5">#chmod 400 droids_im_looking_for</h2>
        </a></div>
      

      
    </nav>

  </div>
  <script src="/js/navicon-shift.js"></script>
</section>
<section class="section">
  <div class="container">
    <div class="subtitle tags is-6 is-pulled-right">
      
      
<a class="subtitle is-6" href="/tags/golang/">#golang</a>



  
  | <a class="subtitle is-6" href="/tags/caddy/">#caddy</a>
  
  | <a class="subtitle is-6" href="/tags/webserver/">#webserver</a>
  
  | <a class="subtitle is-6" href="/tags/https/">#https</a>
  
  | <a class="subtitle is-6" href="/tags/tls/">#tls</a>
  
  | <a class="subtitle is-6" href="/tags/letsencrypt/">#LetsEncrypt</a>
  
  | <a class="subtitle is-6" href="/tags/nginx/">#nginx</a>
  
  | <a class="subtitle is-6" href="/tags/docker/">#docker</a>
  


      
    </div>
    <h2 class="subtitle is-6">February 19, 2018</h2>
    <h1 class="title">Caddy! Team 443 FTW</h1>
    
    <div class="content">
      <p>This one is a gamechanger. It really is.</p>
<p>On a recent Golang obsessed Github browsing spree, I read the following project description: &ldquo;Fast, cross-platform HTTP/2 web server with automatic HTTPS&rdquo;. I&rsquo;ve read that before, and more often than not ended up disappointing myself and resorting to hacks like [this] (<a href="https://blog.tux-sudo.com/posts/letsencrypt-nginx-docker/">https://blog.tux-sudo.com/posts/letsencrypt-nginx-docker/</a>) to create an automatic TLS system for my websites. There are other ways, but almost all of them were semi-automatic in the long run (yay cron!). I decided to try out [Caddy] (<a href="https://caddyserver.com/)">https://caddyserver.com/)</a>.</p>
<p>After about an hour, I had the &ldquo;Luke, I&rsquo;m your father&rdquo; moment. Now, I&rsquo;m happily munching secure cookies on the dark side. Check out the line below:</p>
<p><code>tls tiredsysadmin@deathstar.com</code></p>
<p>That is all you have to configure to get a truly automatic Let&rsquo;s Encrypt HTTPS-enabled website served by caddy.</p>
<p>What&rsquo;s more? Caddy really feels like a breath of fresh air in terms of configuration. It is written with usability in mind. I thought we already had it pretty good with nginx (but I come from Apache, so make of it what you will), but this is even better.</p>
<p>Check out a sample configuration for an entrypoint that I use:</p>
<pre><code>tux-sudo.com {
  tls tanmay.chaudhry@gmail.com

  redir / blog.tux-sudo.com 301
}
</code></pre><p>Yeah, okay it&rsquo;s not much (but isn&rsquo;t that the beauty?). When was the last time you saw an auto-TLS configured in 2 lines? Also, no more returns/redirect to write for HTTP traffic. This does auto-redirects. Stuff like this is why it feels like a true out-of-the-box HTTPS solution. You can still go deep and configure stuff to work the way you want, but more often than not I just want it to work.</p>
<p>But I had a slightly more complex use-case. I wanted to proxy to my prometheus instance. This is running on a raspberry-pi on my internal network behind a dynamic IP. For ISP reasons, I was not able to bind to 443 for the incoming internet. That creates a problem for the let&rsquo;s encrypt challenge. Aw, back to DNS records and manual cert installation? Well, no. Check this out:</p>
<pre><code>prometheus.tux-sudo.com {
  log / /var/log/caddy/caddy-prometheus.log
  basicauth / hah nicetry 
  tls {
    dns route53
  }
  proxy / localhost:9090 {
    transparent
  }
}
</code></pre><p>Yes, that is all. Set your DNS provider creds in environment variables and keep munching those cookies.</p>
<p>The real clincher is that everything here works exactly the same inside containers.</p>
<pre><code>version: '3'

services:
  web:
    image: abiosoft/caddy
    container_name: web
    ports:
      - &quot;80:80&quot;
      - &quot;443:443&quot;
    environment:
      - CADDYPATH=/etc/caddycerts
    volumes:
      - $HOME/.caddy:/etc/caddycerts
      - ./config/caddyfile:/etc/Caddyfile
</code></pre><p>If you&rsquo;re an enthusiast who writes abandonable personal projects every weekend, I urge you to try this out. It is supposed to be production ready as well if you&rsquo;re interested, but that&rsquo;s not something I have tested.</p>
<h1 id="caddyhttpscaddyservercom--caddy-githubhttpsgithubcommholtcaddy"><a href="https://caddyserver.com/">Caddy</a> : <a href="https://github.com/mholt/caddy">Caddy-Github</a></h1>

      
    </div>
    
  </div>
</section>


<section class="section">
  <div class="container">
    <aside><div id="disqus_thread"></div></aside>
  
    <script type="text/javascript">
      var disqus_shortname = 'tux-sudo';
      function disqus() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }
  
      disqus();
  

    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
  </div>
</section>


<section class="section">
  <div class="container has-text-centered">
    <p></p>
    
  </div>
</section>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-83389316-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>




</body>
</html>

